<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/auth/users.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/auth/users.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
require('dotenv').config();
const bcrypt =  require('bcrypt');
const jwt = require('jsonwebtoken');
const SECRET = process.env.SECRET; // place this in your .env
// console.log('token',SECRET);
const mongoDB = require('./models/users/users-model');
const adminMongoDB = require('./models/admin/admin-model');
const timeMongoDB = require('./models/time/time-model');

// let obj={}; //db
let users = {}; //exporting
let roles = {
  user:    ['read'],
  writers: ['read', 'create'],
  accountant: ['read', 'account'],
  admin :  ['read', 'manage','update', 'account','create', 'delete'],
};

/**
 * @param(obj)
 */
users.save = async function(record){
  let reading = await mongoDB.read(record.username);
  let emailCheck =  await mongoDB.read(record.email);
  console.log('123123213123123',reading);
  if (!(reading[0] || emailCheck[0])) {
    record.password  = await bcrypt.hash(record.password, 5);
    let test = await mongoDB.create(record);
    console.log('signup test',test);
    return record;
  }
  // let addNewNote =await mongoDB.create(record);
  return Promise.reject();
};

/**
 * @param {obj} record 
 */
users.saveAdmin = async function(record){
  let reading = await adminMongoDB.read(record.username);
  console.log('123123213123123',reading);
  if (!reading[0]) {
    let test = await adminMongoDB.create(record);
    console.log('signup test',test);
    return record;
  }
  // let addNewNote =await mongoDB.create(record);
  return Promise.reject();
};
/**
 * @description:This function is used to save the time that the employee start his work at the morning
 * @param {obj} record 
 * @param {*} day 
 */
users.saveStartTime = async function(record,day){
  let reading = await timeMongoDB.read(record.username);
  // console.log('123123213123123',reading[0].date.split('/')[0]);
  if (!reading[0]) {
    let test = await timeMongoDB.create(record);
    console.log('signup test',test);
    return record;
  }
  if (!(day==reading[reading.length-1].date.split('/')[0])) {
    let test = await timeMongoDB.create(record);
    console.log('signup test',test);
    return record;
  }
  // let addNewNote =await mongoDB.create(record);
  return Promise.reject();
};
/**
 * @description:This function is used to save the time that the employee end his work at the morning
 * @param {obj} record 
 * @param {*} day 
 */
users.saveEndTime = async function(username){
  let reading = await timeMongoDB.read(username);
  if(!(reading[reading.length-1].flag=='true')){
  // console.log('123123213123123',reading[0]._id);
  // if (!reading[0]) {
    reading[reading.length-1].flag=true;
    var dateEndTime = new Date();
    let hour  = dateEndTime.getHours();
    let min  = dateEndTime.getMinutes();
    reading[reading.length-1].finishTime=hour+':'+min;
    let time1 = reading[reading.length-1].finishTime;
    let time2 = reading[reading.length-1].startTime;
    let splitTime1= time1.split(':');
    let splitTime2= time2.split(':');
    let hourcalc = parseInt(splitTime1[0])-parseInt(splitTime2[0]);
    let minute = parseInt(splitTime1[1])-parseInt(splitTime2[1]);
    hourcalc = hourcalc + minute/60;
    reading[0].workHours=hourcalc;
    let userFromAdmin = await adminMongoDB.read(username);
    userFromAdmin[0].workHours=userFromAdmin[0].workHours+hourcalc;
    await adminMongoDB.PATCH(userFromAdmin[0]._id,userFromAdmin[0]);  
    let test = await timeMongoDB.PATCH(reading[reading.length-1]._id,reading[reading.length-1]);
    // console.log('signup test',test);
    return test;
  }
  return Promise.reject();
};

/**
 * @param(string)
 */
// compare the password with the encrypted one
users.authenticateBasic = async function(username, password) {
  let reading = await adminMongoDB.read(username);
  let valid = await bcrypt.compare(password, reading[0].password);
  console.log(valid);
  console.log(username);
  
  return valid ? username : Promise.reject();
};

/**
 * @param {obj} user 
 */
users.generateTokenUp =  function (user) {
  // ,{expiresIn:900}
  let token = jwt.sign({username: user.username , capabilities: roles[user.role]},SECRET,{expiresIn:90000});
  return token;
};
/**
  * 
 * @param {obj} user 
 */

users.generateTokenIn =  async function (user) {
  let reading =  await adminMongoDB.read(user);
  console.log('TokengenerateTokengenerateTokengenerate',reading[0].role);
  // let username =  user;
  // let capabilities = roles[reading[0].role] || user.role;
  
  // ,{expiresIn:900}
  let token = await jwt.sign({id: reading[0]._id },SECRET,{expiresIn:90000}  );
  console.log('tokentokentokentokentoken',token);
  console.log('##########################################################');
  return token;
};
/**
 * 
 * @param {obj} record 
 */
users.getUserProfile = async function(record){
  let reading = await adminMongoDB.readId(record);
  return reading[0];
};
/**
 * 
 * @param {obj} record 
 */
users.list = async function(record){
  let reading = await mongoDB.read(record);
  return reading;
};
/**
 * 
 * @param {string} id 
 * @param {obj} record 
 */
users.updateUserProfile = async function(id,record){
  console.log(id,record);
  let reading = await adminMongoDB.PATCH(id,record);
  return reading[0];
};
/**
 * 
 * @param {string} token 
 */

users.verifyToken = function (token) {
  console.log('TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT',token);
  return  jwt.verify(token, SECRET,async function(err, decoded){
    if (err) {
      console.log('err>>> ', err);
      return Promise.reject(err);
    }
    console.log('decoded >>>> ',decoded); // {username: usernameValue, ...}
    console.log('decoded >>>> ',decoded.id); // {username: usernameValue, ...}
    let id = decoded.id; // decoded.id
    let reading = await adminMongoDB.readId(id);
    console.log('GGGGGGGGGGGGGGGGGGGGGGGGGGGGG',reading); 
    if (reading[0]) {
      return Promise.resolve(decoded);
    } 
    return Promise.reject();
  });
};
/**
 * 
 * @param {string} userId 
 * @param {string} accountatname 
 * @param {number} livingAllowanceAndRewards 
 */
users.accountentData = async function(userId,accountatname,livingAllowanceAndRewards){
  let reading = await adminMongoDB.readId(userId);
  let hourSalary = {
    admin:    22,
    marketing: 12,
    accountant: 16,
    salesperson :  15,
    hr:8,
    developer:19,
    qa:15,
  };

  let livingAllowance = livingAllowanceAndRewards.livingAllowance;
  let rewards = livingAllowanceAndRewards.rewards;
  let basicSalary = (reading[0].workHours)*(hourSalary.reading[0].position);
  let socialSecurity =  basicSalary*7.5/100;
  let netSalary = basicSalary+livingAllowance+rewards-socialSecurity;
  let financialPaper={
    'Acountant Name:':accountatname,
    'User Name:':reading[0].username,
    'Working hours':reading[0].workHours,
    'Basic salary':basicSalary,
    'Living allowance':livingAllowance,
    'Rewards':rewards,
    'Social security':socialSecurity,
    'Net salary':netSalary,
  };
  
  return financialPaper;
};

module.exports = users;


</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-admin%2520model.html">admin model</a></li><li><a href="module-admin-schema.html">admin-schema</a></li><li><a href="module-Model.html">Model</a></li><li><a href="module-pol.html">pol</a></li><li><a href="module-time.html">time</a></li><li><a href="module-time%2520model.html">time model</a></li><li><a href="module-users%2520infomation.html">users infomation</a></li><li><a href="module-users%2520model.html">users model</a></li></ul><h3>Classes</h3><ul><li><a href="module-Model-Model.html">Model</a></li></ul><h3>Global</h3><ul><li><a href="global.html#acceptUser">acceptUser</a></li><li><a href="global.html#accountantMainHandler">accountantMainHandler</a></li><li><a href="global.html#addUserHandler">addUserHandler</a></li><li><a href="global.html#deleteUserHandler">deleteUserHandler</a></li><li><a href="global.html#exchangeCodeForToken">exchangeCodeForToken</a></li><li><a href="global.html#getRemoteUserInfo">getRemoteUserInfo</a></li><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#rejectUser">rejectUser</a></li><li><a href="global.html#signin">signin</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#updateUserHandler">updateUserHandler</a></li><li><a href="global.html#userEditProfile">userEditProfile</a></li><li><a href="global.html#userendHandler">userendHandler</a></li><li><a href="global.html#userProfileHandler">userProfileHandler</a></li><li><a href="global.html#userstartHandler">userstartHandler</a></li><li><a href="global.html#uservacation">uservacation</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed Jun 24 2020 09:48:36 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
